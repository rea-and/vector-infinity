<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vector Infinity</title>
    <!-- Markdown rendering libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-theme">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            /* Dark theme (default) */
            --bg-primary: #343541;
            --bg-secondary: #40414f;
            --bg-tertiary: #565869;
            --bg-hover: #4e4f60;
            --text-primary: #ececf1;
            --text-secondary: #c5c5d2;
            --text-tertiary: #8e8ea0;
            --border-color: #565869;
            --accent-color: #10a37f;
            --accent-hover: #0d8f6e;
            --user-message-bg: #10a37f;
            --assistant-message-bg: #40414f;
            --sidebar-bg: #202123;
            --input-bg: #40414f;
            --input-border: #565869;
            --card-bg: #40414f;
            --code-bg: #2d2d30;
            --link-color: #58a6ff;
        }
        
        [data-theme="light"] {
            /* Light theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f7f7f8;
            --bg-tertiary: #ececf1;
            --bg-hover: #e5e5e6;
            --text-primary: #353740;
            --text-secondary: #6e6e80;
            --text-tertiary: #8e8ea0;
            --border-color: #d1d5db;
            --accent-color: #10a37f;
            --accent-hover: #0d8f6e;
            --user-message-bg: #10a37f;
            --assistant-message-bg: #f7f7f8;
            --sidebar-bg: #f7f7f8;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --card-bg: #ffffff;
            --code-bg: #f6f8fa;
            --link-color: #0366d6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'S√∂hne', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile */
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile */
        }
        
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
            position: relative;
            z-index: 1000;
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .menu-toggle {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 20px;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Mobile header spacing - equal gaps between elements */
        @media (max-width: 768px) {
            .menu-toggle {
                left: 16px; /* Hamburger position */
            }
            
            .chat-title-mobile {
                left: 72px; /* 16px (left) + 40px (hamburger) + 16px (gap) = 72px */
                right: 72px; /* 16px (right) + 40px (+ button) + 16px (gap) = 72px */
            }
            
            .chat-title-mobile-new-btn {
                right: 16px; /* + button position */
            }
        }
        
        .menu-toggle:hover {
            background: var(--bg-hover);
        }
        
        .menu-toggle svg {
            width: 24px;
            height: 24px;
        }
        
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .sidebar-close {
            display: none;
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 24px;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .sidebar-close:hover {
            background: var(--bg-hover);
        }
        
        @media (max-width: 768px) {
            .sidebar-close {
                display: flex;
            }
        }
        
        .theme-toggle {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s ease;
        }
        
        .theme-toggle:hover {
            background: var(--bg-hover);
        }
        
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .nav-item {
            padding: 10px 12px;
            margin: 4px 0;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-item:hover {
            background: var(--bg-hover);
        }
        
        .nav-item.active {
            background: var(--bg-secondary);
            font-weight: 500;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        /* Show new thread button only when chat tab is active */
        #chat.tab-content.active .chat-header .btn-new-thread {
            display: inline-block;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            overflow-y: auto;
        }
        
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .card h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 20px;
            color: var(--text-primary);
        }
        
        .btn {
            padding: 10px 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }
        
        .btn:hover {
            background: var(--accent-hover);
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-success {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
        }
        
        .status-error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .status-running {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        th {
            background: var(--bg-secondary);
            font-weight: 600;
        }
        
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            min-height: 100px;
            resize: vertical;
            background: var(--input-bg);
            color: var(--text-primary);
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
            background: var(--input-bg);
            color: var(--text-primary);
        }
        
        .response-box {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        .test-form {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
        }
        
        .test-form label {
            display: block;
            margin: 8px 0 4px 0;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }
        
        /* Markdown styles for chat messages */
        .markdown-content {
            word-wrap: break-word;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
            line-height: 1.25;
        }
        
        .markdown-content h1 {
            font-size: 2em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
            color: var(--text-primary);
        }
        
        .markdown-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
            color: var(--text-primary);
        }
        
        .markdown-content h3 {
            font-size: 1.25em;
            color: var(--text-primary);
        }
        
        .markdown-content h4 {
            font-size: 1em;
            color: var(--text-primary);
        }
        
        .markdown-content p {
            margin-bottom: 1em;
            color: var(--text-primary);
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }
        
        .markdown-content li {
            margin-bottom: 0.25em;
            color: var(--text-primary);
        }
        
        .markdown-content code {
            background-color: var(--code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            color: var(--text-primary);
        }
        
        .markdown-content pre {
            background-color: var(--code-bg);
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin-bottom: 1em;
            border: 1px solid var(--border-color);
        }
        
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            font-size: 0.85em;
            line-height: 1.45;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid var(--border-color);
            padding-left: 16px;
            margin: 0 0 1em 0;
            color: var(--text-secondary);
        }
        
        .markdown-content table {
            border-collapse: collapse;
            margin-bottom: 1em;
            width: 100%;
        }
        
        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid var(--border-color);
            padding: 6px 13px;
        }
        
        .markdown-content table th {
            background-color: var(--bg-secondary);
            font-weight: 600;
        }
        
        .markdown-content table tr:nth-child(2n) {
            background-color: var(--bg-secondary);
        }
        
        .markdown-content a {
            color: var(--link-color);
            text-decoration: none;
        }
        
        .markdown-content a:hover {
            text-decoration: underline;
        }
        
        .markdown-content hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 1.5em 0;
        }
        
        .markdown-content strong {
            font-weight: 600;
        }
        
        .markdown-content em {
            font-style: italic;
        }
        
        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 1em 0;
        }
        
        /* ChatGPT-style Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: row;
            height: 100%;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .chat-threads-sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .chat-threads-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .chat-threads-header h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        
        .chat-threads-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .chat-thread-item {
            padding: 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .chat-thread-item:hover {
            background: var(--bg-hover);
        }
        
        .chat-thread-item.active {
            background: var(--accent-color);
            color: white;
        }
        
        .chat-thread-content {
            flex: 1;
            min-width: 0;
        }
        
        .chat-thread-title {
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .chat-thread-time {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .chat-thread-delete {
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .chat-thread-item:hover .chat-thread-delete {
            opacity: 0.6;
        }
        
        .chat-thread-item:hover .chat-thread-delete:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .chat-thread-item.active .chat-thread-delete {
            opacity: 0.7;
        }
        
        .chat-thread-item.active:hover .chat-thread-delete:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .chat-header h2 {
            font-size: 18px;
            margin: 0;
            color: var(--text-primary);
            flex: 1;
        }
        
        .chat-header .btn-new-thread {
            padding: 6px 12px;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .chat-title-mobile {
            display: none;
            position: fixed;
            top: 16px;
            left: 72px; /* 16px (left) + 40px (hamburger) + 16px (gap) = 72px */
            right: 72px; /* 16px (right) + 40px (+ button) + 16px (gap) = 72px */
            height: 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0 12px;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .chat-title-mobile h2 {
            font-size: 14px;
            margin: 0;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-title-mobile-new-btn {
            display: none;
            position: fixed;
            top: 16px;
            right: 16px;
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .chat-title-mobile-new-btn:hover {
            background: var(--accent-hover);
        }
        
        .sidebar-threads {
            padding: 8px;
            border-top: 1px solid var(--border-color);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .sidebar-threads-header {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sidebar-thread-item {
            padding: 10px 12px;
            margin-bottom: 2px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: var(--text-primary);
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .sidebar-thread-item:hover {
            background: var(--bg-hover);
        }
        
        .sidebar-thread-item.active {
            background: var(--accent-color);
            color: white;
        }
        
        .sidebar-thread-content {
            flex: 1;
            min-width: 0;
        }
        
        .sidebar-thread-title {
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .sidebar-thread-delete {
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .sidebar-thread-item:hover .sidebar-thread-delete {
            opacity: 0.6;
        }
        
        .sidebar-thread-item:hover .sidebar-thread-delete:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-thread-item.active .sidebar-thread-delete {
            opacity: 0.7;
        }
        
        .sidebar-thread-item.active:hover .sidebar-thread-delete:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .sidebar-thread-time {
            font-size: 11px;
            opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .chat-threads-sidebar {
                display: none; /* Hide on mobile for now */
            }
            
            .chat-header {
                display: none; /* Hide desktop header on mobile */
            }
            
            .chat-title-mobile {
                display: none; /* Hidden by default */
            }
            
            .chat-title-mobile-new-btn {
                display: none; /* Hidden by default */
            }
            
            /* Hide mobile new button when sidebar is open */
            .sidebar.open ~ .chat-title-mobile-new-btn,
            body.sidebar-open .chat-title-mobile-new-btn {
                display: none;
            }
            
            /* Show mobile title bar and new button only when chat tab is active */
            #chat.tab-content.active ~ .chat-title-mobile,
            body:has(#chat.tab-content.active) .chat-title-mobile {
                display: flex;
            }
            
            #chat.tab-content.active ~ .chat-title-mobile-new-btn,
            body:has(#chat.tab-content.active) .chat-title-mobile-new-btn {
                display: flex;
            }
            
            .chat-messages {
                padding-top: 62px !important; /* Space for hamburger (16px top + 40px height + 16px gap) + title bar (40px height + 16px gap) - reduced by 30% */
            }
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-primary);
        }
        
        /* Ensure chat messages start below the chat header on desktop */
        .chat-main-area .chat-messages {
            padding-top: 0; /* Chat header is in normal flow, no extra padding needed */
        }
        
        .chat-message {
            display: flex;
            gap: 16px;
            padding: 24px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .chat-message:last-child {
            border-bottom: none;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .message-avatar.user {
            background: var(--user-message-bg);
            color: white;
        }
        
        .message-avatar.assistant {
            background: var(--accent-color);
            color: white;
        }
        
        .message-content {
            flex: 1;
            padding-top: 4px;
        }
        
        .message-content.user {
            color: var(--text-primary);
        }
        
        .message-content.assistant {
            color: var(--text-primary);
        }
        
        .message-content.assistant .markdown-content {
            color: var(--text-primary);
        }
        
        /* Markdown content styling - ChatGPT-like formatting */
        .markdown-content {
            line-height: 1.75;
            word-wrap: break-word;
        }
        
        /* Headers */
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 16px;
            color: var(--text-primary);
            line-height: 1.25;
        }
        
        .markdown-content h1 {
            font-size: 2em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .markdown-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 6px;
        }
        
        .markdown-content h3 {
            font-size: 1.25em;
        }
        
        .markdown-content h4 {
            font-size: 1.1em;
        }
        
        .markdown-content h5 {
            font-size: 1em;
        }
        
        .markdown-content h6 {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        /* Paragraphs */
        .markdown-content p {
            margin: 16px 0;
        }
        
        /* Lists */
        .markdown-content ul,
        .markdown-content ol {
            margin: 16px 0;
            padding-left: 30px;
        }
        
        .markdown-content li {
            margin: 8px 0;
        }
        
        .markdown-content ul {
            list-style-type: disc;
        }
        
        .markdown-content ol {
            list-style-type: decimal;
        }
        
        .markdown-content ul ul,
        .markdown-content ol ol,
        .markdown-content ul ol,
        .markdown-content ol ul {
            margin: 4px 0;
        }
        
        /* Code blocks */
        .markdown-content pre {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .markdown-content pre code {
            background: transparent;
            padding: 0;
            border: none;
            border-radius: 0;
            font-size: inherit;
            color: inherit;
        }
        
        /* Inline code */
        .markdown-content code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Courier New', Courier, monospace;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        /* Blockquotes */
        .markdown-content blockquote {
            border-left: 4px solid var(--accent-color);
            padding: 8px 16px;
            margin: 16px 0;
            background: var(--bg-secondary);
            border-radius: 4px;
            color: var(--text-secondary);
        }
        
        .markdown-content blockquote p {
            margin: 0;
        }
        
        /* Tables */
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .markdown-content thead {
            background: var(--bg-secondary);
        }
        
        .markdown-content th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .markdown-content td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .markdown-content tbody tr:last-child td {
            border-bottom: none;
        }
        
        .markdown-content tbody tr:hover {
            background: var(--bg-hover);
        }
        
        /* Links */
        .markdown-content a {
            color: var(--link-color);
            text-decoration: none;
        }
        
        .markdown-content a:hover {
            text-decoration: underline;
        }
        
        /* Horizontal rules */
        .markdown-content hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 24px 0;
        }
        
        /* Images */
        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        /* Strong and emphasis */
        .markdown-content strong {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .markdown-content em {
            font-style: italic;
        }
        
        /* Task lists (GitHub Flavored Markdown) */
        .markdown-content input[type="checkbox"] {
            margin-right: 8px;
        }
        
        /* Nested content spacing */
        .markdown-content > *:first-child {
            margin-top: 0;
        }
        
        .markdown-content > *:last-child {
            margin-bottom: 0;
        }
        
        .chat-input-container {
            padding: 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .chat-input-wrapper {
            max-width: 768px;
            margin: 0 auto;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            padding: 12px 48px 12px 16px;
            border: 1px solid var(--input-border);
            border-radius: 12px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 16px;
            resize: none;
            max-height: 200px;
            font-family: inherit;
            line-height: 1.5;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .chat-send-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--accent-color);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .chat-send-button:hover {
            background: var(--accent-hover);
        }
        
        .chat-send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .chat-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .chat-empty-state h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .chat-empty-state p {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .loading-dots {
            display: inline-flex;
            gap: 4px;
            padding: 8px 0;
        }
        
        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        
        /* Import progress styles */
        .import-progress {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            margin-top: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .test-form input[type="text"],
        .test-form input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .test-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #ddd;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .test-result pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .test-result.error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .test-result.success {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .plugin-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .plugin-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .plugin-card h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .plugin-card p {
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .plugin-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }
        
        .plugin-toggle label {
            display: flex;
            align-items: center;
            cursor: pointer;
            flex: 1;
            margin: 0;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .toggle-switch.active {
            background: var(--accent-color, #667eea);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: left 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch.active::after {
            left: 27px;
        }
        
        .plugin-toggle input[type="checkbox"] {
            display: none;
        }
        
        .plugin-toggle label span {
            user-select: none;
        }
        
        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }
            
            /* Hide hamburger menu and title bar when sidebar is open */
            .sidebar.open ~ .menu-toggle,
            body.sidebar-open .menu-toggle {
                display: none;
            }
            
            .sidebar.open ~ .chat-title-mobile,
            body.sidebar-open .chat-title-mobile {
                display: none;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
                z-index: 1000;
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                width: 100%;
                padding-top: 0; /* No padding needed, chat messages handle their own padding */
            }
            
            /* Add left padding to screen titles on non-Chat screens to avoid hamburger menu */
            .main-content .card h2 {
                margin-top: 0; /* Ensure no extra top margin on page titles */
                padding-left: 72px; /* Space for hamburger menu (40px + 16px gap + 16px) */
            }
            
            /* Exclude chat screen titles (they have their own positioning) */
            #chat .card h2 {
                padding-left: 0;
            }
            
            /* Also handle h2 in Users section that's not in a card */
            #users .container > h2 {
                padding-left: 72px; /* Space for hamburger menu */
            }
            
            .container {
                padding: 10px;
                padding-top: 0; /* Remove top padding since main-content already has it */
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
            
            .chat-messages {
                padding: 16px;
                padding-top: 62px !important; /* Space for hamburger + title bar on mobile - reduced by 30% */
                padding-bottom: 8px;
            }
            
            .chat-input-container {
                padding: 12px;
                padding-bottom: max(12px, env(safe-area-inset-bottom));
                position: sticky;
                bottom: 0;
            }
            
            .chat-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            body {
                height: 100vh;
                height: 100dvh; /* Use dynamic viewport height on mobile */
            }
            
            .app-container {
                height: 100vh;
                height: 100dvh;
            }
            
            .chat-container {
                height: 100%;
                min-height: 0; /* Allows flexbox to shrink */
            }
        }
    </style>
</head>
<body>
    <button class="menu-toggle" onclick="toggleSidebar()" id="menu-toggle" aria-label="Toggle menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>
    <div class="chat-title-mobile">
        <h2 id="chat-thread-title-mobile">New Conversation</h2>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="sidebar-close" onclick="closeSidebar()" aria-label="Close sidebar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <h1>Vector Infinity</h1>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="showTab('chat')" data-tab="chat">
                    üí¨ Chat
                </div>
                <div class="nav-item" onclick="showTab('run')" data-tab="run">
                    ‚ö° Plugins
                </div>
                <div class="nav-item" onclick="showTab('imports')" data-tab="imports">
                    üìã Import Logs
                </div>
                <div class="nav-item" onclick="showTab('stats')" data-tab="stats">
                    üìä Statistics
                </div>
                <div class="nav-item" id="nav-users" onclick="showTab('users')" data-tab="users" style="display: none;">
                    üë• Users
                </div>
                <div class="nav-item" onclick="showTab('settings')" data-tab="settings">
                    ‚öôÔ∏è Settings
                </div>
            </div>
            <div class="sidebar-threads" id="sidebar-threads">
                <div class="sidebar-threads-header">Conversations</div>
                <div id="sidebar-threads-list">
                    <!-- Threads will be loaded here -->
                </div>
            </div>
            <div class="sidebar-footer" style="padding: 12px; border-top: 1px solid var(--border-color); margin-top: auto;">
                <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle" style="margin-bottom: 12px;">
                    <span id="theme-icon">üåô</span>
                    <span id="theme-text">Dark Mode</span>
                </button>
                <div id="user-info" style="margin-bottom: 12px; color: var(--text-secondary); font-size: 12px;">
                    <div id="user-email" style="font-weight: 500; color: var(--text-primary); margin-bottom: 4px;"></div>
                </div>
                <button class="btn btn-secondary" onclick="handleLogout()" style="width: 100%; margin: 0; padding: 8px; font-size: 13px;">
                    üö™ Logout
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <button class="chat-title-mobile-new-btn" onclick="newChatThread()" aria-label="New conversation">+</button>
            <div id="chat" class="tab-content active">
                <div class="chat-container">
                    <div class="chat-threads-sidebar">
                        <div class="chat-threads-header">
                            <h3>Conversations</h3>
                            <button class="btn" onclick="newChatThread()" style="width: 100%; padding: 8px; font-size: 13px;">
                                + New Conversation
                            </button>
                        </div>
                        <div class="chat-threads-list" id="chat-threads-list">
                            <!-- Threads will be loaded here -->
                        </div>
                    </div>
                    <div class="chat-main-area">
                        <div class="chat-header">
                            <div style="flex: 1;">
                                <h2 id="chat-thread-title">New Conversation</h2>
                                <div id="chat-model-indicator" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                    Model: <span id="chat-model-name">Loading...</span>
                                </div>
                            </div>
                            <button class="btn btn-new-thread" onclick="newChatThread()">+ New</button>
                        </div>
                        <div class="chat-messages" id="chat-messages">
                            <div class="chat-empty-state">
                                <h2>How can I help you today?</h2>
                                <p>Ask questions about your imported data from Gmail, WhatsApp, WHOOP, and more.</p>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <div class="chat-input-wrapper">
                                <textarea id="chat-input" class="chat-input" placeholder="Message Vector Infinity..." rows="1" onkeydown="handleChatInputKeydown(event)"></textarea>
                                <button class="chat-send-button" onclick="sendChatMessage()" id="chat-send-btn">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M.5 1.163A1 1 0 0 1 1.97.28l12.868 6.837a1 1 0 0 1 0 1.766L1.969 15.72A1 1 0 0 1 .5 14.836V10.33a1 1 0 0 1 .816-.983L8.5 8 1.316 6.653A1 1 0 0 1 .5 5.67V1.163Z" fill="currentColor"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="imports" class="tab-content">
                <div class="container">
                    <div class="card">
                        <h2>Import Logs</h2>
                        <button class="btn" onclick="loadImports()">Refresh</button>
                        <div id="imports-table"></div>
                    </div>
                </div>
            </div>
            
            <div id="run" class="tab-content">
                <div class="container">
                    <div class="card">
                        <h2>Plugins</h2>
                        <button class="btn btn-success" onclick="runAllImports()">Run All Imports</button>
                        <div id="plugins-list"></div>
                    </div>
                </div>
            </div>
            
            <div id="stats" class="tab-content">
                <div class="container">
                    <div class="card">
                        <h2>Statistics</h2>
                        <button class="btn" onclick="loadStats()">Refresh</button>
                        <button class="btn btn-success" onclick="exportEmails()">
                            üì• Export All Emails
                        </button>
                        <button class="btn btn-success" onclick="exportWhoop()">
                            üì• Export WHOOP Data
                        </button>
                        <button class="btn btn-secondary" onclick="reuploadToVectorStore()">
                            üîÑ Re-upload All Data to Vector Store
                        </button>
                        <div id="stats-content"></div>
                    </div>
                </div>
            </div>
            
            <div id="users" class="tab-content">
                <div class="container">
                    <h2>User Management</h2>
                    <div id="users-content">
                        <p>Loading users...</p>
                    </div>
                </div>
            </div>
            
            <div id="settings" class="tab-content">
                    <div class="container">
                        <div class="card">
                            <h2>Settings</h2>
                            <div style="margin-top: 20px;">
                                <h3>Data Management</h3>
                                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                                    Clear all imported data from the database. This action cannot be undone.
                                </p>
                                <button class="btn btn-danger" onclick="clearAllData()">
                                    Clear All Data
                                </button>
                            </div>
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <h3>AI Chat Instructions</h3>
                                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                                    Customize the instructions that guide the AI's behavior. These instructions are used when chatting with your data. Changes will apply to new conversations.
                                </p>
                                <textarea 
                                    id="assistant-instructions-textarea" 
                                    style="width: 100%; min-height: 200px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-family: inherit; font-size: 14px; line-height: 1.5; resize: vertical; margin-bottom: 15px;"
                                    placeholder="Enter custom instructions for the AI..."
                                ></textarea>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                                    <button class="btn btn-primary" onclick="saveAssistantInstructions()" style="min-width: 150px; padding: 10px 20px;">
                                        üíæ Save Instructions
                                    </button>
                                    <button class="btn btn-secondary" onclick="resetAssistantInstructions()" style="min-width: 150px; padding: 10px 20px;">
                                        üîÑ Reset to Default
                                    </button>
                                    <span id="assistant-instructions-status" style="color: var(--text-secondary); font-size: 13px; margin-left: 10px;"></span>
                                </div>
                            </div>
                            
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <h3>AI Chat Model</h3>
                                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                                    Select which GPT model to use for chat. The model will be updated on your next chat message. Different models have different capabilities and costs.
                                </p>
                                <div style="margin-bottom: 15px;">
                                    <label for="assistant-model-select" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                                        Model:
                                    </label>
                                    <select 
                                        id="assistant-model-select" 
                                        style="width: 100%; max-width: 400px; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-family: inherit; font-size: 14px; cursor: pointer;"
                                    >
                                        <option value="">Loading models...</option>
                                    </select>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                                    <button class="btn btn-primary" onclick="saveAssistantModel()" style="min-width: 150px; padding: 10px 20px;">
                                        üíæ Save Model
                                    </button>
                                    <span id="assistant-model-status" style="color: var(--text-secondary); font-size: 13px; margin-left: 10px;"></span>
                                </div>
                                <div id="assistant-model-info" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color); margin-top: 10px;">
                                    <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                                        <strong>Current Model:</strong> <span id="assistant-model-current">Loading...</span>
                                    </p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <h3>Account</h3>
                                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                                    Log out of your account and return to the login page.
                                </p>
                                <button class="btn btn-secondary" onclick="handleLogout()" style="min-width: 150px; padding: 10px 20px;">
                                    üö™ Logout
                                </button>
                            </div>
                            
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <h3>Factory Reset</h3>
                                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                                    <strong style="color: var(--text-primary);">‚ö†Ô∏è DANGER ZONE ‚ö†Ô∏è</strong><br>
                                    This will permanently delete <strong>EVERYTHING</strong>:
                                </p>
                                <ul style="color: var(--text-secondary); margin-bottom: 15px; padding-left: 20px;">
                                    <li>All imported data (emails, WhatsApp, WHOOP, etc.)</li>
                                    <li>All import logs</li>
                                    <li>All temporary files</li>
                                    <li>All log files</li>
                                    <li>All OpenAI vector store files</li>
                                    <li>OAuth authentication tokens</li>
                                    <li>The entire database (will be recreated empty)</li>
                                </ul>
                                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                                    <strong style="color: #e74c3c;">This action CANNOT be undone!</strong> Use this only if you want to completely start over.
                                </p>
                                <button class="btn btn-danger" onclick="factoryReset()" style="background: #c0392b; border: 2px solid #a93226;">
                                    üî• Factory Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api';
        
        // Wrapper for fetch that always includes credentials (cookies)
        // This ensures session cookies are sent with all API requests
        async function apiFetch(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',  // Always include cookies
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            return fetch(url, { ...defaultOptions, ...options });
        }
        
        // Event delegation for reset buttons (works with dynamically generated content)
        document.addEventListener('click', function(e) {
            if (e.target && e.target.hasAttribute('data-reset-plugin')) {
                e.preventDefault();
                e.stopPropagation();
                const pluginName = e.target.getAttribute('data-reset-plugin');
                console.log('Reset button clicked for plugin:', pluginName);
                if (typeof resetPlugin === 'function') {
                    resetPlugin(pluginName);
                } else {
                    console.error('resetPlugin function not found!');
                }
            }
        });
        
        // Configure marked.js for markdown rendering (after libraries load)
        function configureMarkdown() {
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,  // Convert \n to <br>
                    gfm: true,     // GitHub Flavored Markdown
                    highlight: function(code, lang) {
                        if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (err) {
                                console.error('Highlight error:', err);
                            }
                        }
                        if (typeof hljs !== 'undefined') {
                            try {
                                return hljs.highlightAuto(code).value;
                            } catch (err) {
                                console.error('Highlight error:', err);
                            }
                        }
                        return code;
                    }
                });
            }
        }
        
        // Function to safely render markdown
        function renderMarkdown(text) {
            if (!text) return '';
            // Ensure markdown is configured
            configureMarkdown();
            if (typeof marked !== 'undefined') {
                try {
                    return marked.parse(text);
                } catch (err) {
                    console.error('Markdown rendering error:', err);
                    // Fallback to plain text with line breaks
                    return text.replace(/\n/g, '<br>');
                }
            }
            // Fallback if marked.js is not loaded
            return text.replace(/\n/g, '<br>');
        }
        
        // Configure markdown on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', configureMarkdown);
        } else {
            configureMarkdown();
        }
        
        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeToggle(savedTheme);
            updateCodeHighlightTheme(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme);
            updateCodeHighlightTheme(newTheme);
        }
        
        function updateThemeToggle(theme) {
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            if (icon && text) {
                icon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
                text.textContent = theme === 'dark' ? 'Dark Mode' : 'Light Mode';
            }
        }
        
        function updateCodeHighlightTheme(theme) {
            // Update highlight.js theme based on current theme
            const link = document.getElementById('hljs-theme');
            if (link) {
                const newTheme = theme === 'dark' ? 'github-dark' : 'github';
                link.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/${newTheme}.min.css`;
            }
        }
        
        // Sidebar toggle functions for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isOpen = sidebar.classList.contains('open');
            
            if (isOpen) {
                closeSidebar();
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
                document.body.classList.add('sidebar-open');
                document.body.style.overflow = 'hidden'; // Prevent body scroll when sidebar is open
            }
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            document.body.classList.remove('sidebar-open');
            document.body.style.overflow = ''; // Restore body scroll
        }
        
        // Close sidebar when clicking on nav items on mobile
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Load chat instructions and model when Settings tab is shown
            if (tabName === 'settings') {
                loadChatInstructions();
                loadAssistantModel();
            }
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Close sidebar on mobile after selecting a tab
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
            
            if (tabName === 'imports') loadImports();
            if (tabName === 'run') loadPlugins();
            if (tabName === 'chat') initChat();
            if (tabName === 'stats') loadStats();
            if (tabName === 'users' && currentUser && currentUser.is_admin) loadUsers();
        }
        
        // Handle window resize - close sidebar if screen becomes larger
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        });
        
        function handleChatInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
            // Auto-resize textarea
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }
        
        // Store active polling intervals for running imports
        const activeImportPollers = new Map();
        const activePluginPollers = new Map(); // For plugin tab polling
        
        async function loadImports() {
            try {
                const response = await apiFetch(`${API_BASE}/imports?limit=50`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const imports = await response.json();
                
                if (!imports || imports.length === 0) {
                    document.getElementById('imports-table').innerHTML = '<p>No import logs yet.</p>';
                    return;
                }
                
                // Clear existing pollers
                activeImportPollers.forEach(interval => clearInterval(interval));
                activeImportPollers.clear();
                
                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>Plugin</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Started</th>
                                <th>Completed</th>
                                <th>Records</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${imports.map(imp => {
                                let progressHtml = '-';
                                if (imp.status === 'running') {
                                    const progressMsg = imp.progress_message || 'Processing...';
                                    const progressCount = imp.progress_total > 0 ? ` (${imp.progress_current || 0}/${imp.progress_total})` : '';
                                    const progressPercent = imp.progress_total > 0 ? Math.round(((imp.progress_current || 0) / imp.progress_total) * 100) : 0;
                                    const progressBar = imp.progress_total > 0 ? `<div class="progress-bar"><div class="progress-fill" style="width: ${progressPercent}%"></div></div>` : '';
                                    
                                    progressHtml = `<div id="progress-${imp.id}" class="import-progress">
                                        ${progressMsg}${progressCount}
                                        ${progressBar}
                                       </div>`;
                                }
                                
                                return `
                                <tr>
                                    <td>${imp.plugin_name}</td>
                                    <td><span class="status-badge status-${imp.status}">${imp.status}</span></td>
                                    <td>${progressHtml}</td>
                                    <td>${imp.started_at ? new Date(imp.started_at).toLocaleString() : '-'}</td>
                                    <td>${imp.completed_at ? new Date(imp.completed_at).toLocaleString() : '-'}</td>
                                    <td>${imp.records_imported || 0}</td>
                                    <td>${imp.error_message || '-'}</td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('imports-table').innerHTML = table;
                
                // Start polling for running imports
                imports.filter(imp => imp.status === 'running').forEach(imp => {
                    startImportProgressPolling(imp.id);
                });
            } catch (error) {
                console.error('Error loading imports:', error);
                document.getElementById('imports-table').innerHTML = `<p style="color: red;">Error loading imports: ${error.message}</p>`;
            }
        }
        
        function startImportProgressPolling(logId) {
            // Clear any existing poller for this import
            if (activeImportPollers.has(logId)) {
                clearInterval(activeImportPollers.get(logId));
            }
            
            const pollInterval = setInterval(async () => {
                try {
                    const statusResponse = await apiFetch(`${API_BASE}/imports/${logId}/status`);
                    if (!statusResponse.ok) {
                        clearInterval(pollInterval);
                        activeImportPollers.delete(logId);
                        return;
                    }
                    
                    const status = await statusResponse.json();
                    const progressElement = document.getElementById(`progress-${logId}`);
                    
                    if (progressElement) {
                        let progressHtml = status.progress_message || 'Processing...';
                        if (status.progress_total > 0) {
                            progressHtml += ` (${status.progress_current || 0}/${status.progress_total})`;
                            const percent = Math.round(((status.progress_current || 0) / status.progress_total) * 100);
                            progressHtml += `<div class="progress-bar"><div class="progress-fill" style="width: ${percent}%"></div></div>`;
                        }
                        progressElement.innerHTML = progressHtml;
                    }
                    
                    // Update status badge if status changed
                    const row = progressElement?.closest('tr');
                    if (row) {
                        const statusCell = row.querySelector('.status-badge');
                        if (statusCell && statusCell.textContent !== status.status) {
                            statusCell.textContent = status.status;
                            statusCell.className = `status-badge status-${status.status}`;
                        }
                        
                        // Update records count
                        const recordsCell = row.querySelectorAll('td')[5];
                        if (recordsCell) {
                            recordsCell.textContent = status.records_imported || 0;
                        }
                    }
                    
                    // Stop polling if import is complete
                    if (status.status === 'success' || status.status === 'error') {
                        clearInterval(pollInterval);
                        activeImportPollers.delete(logId);
                        
                        // Reload imports to show final state
                        setTimeout(() => loadImports(), 1000);
                    }
                } catch (error) {
                    console.error(`Error polling import ${logId}:`, error);
                }
            }, 1000); // Poll every second
            
            activeImportPollers.set(logId, pollInterval);
        }
        
        async function loadPlugins() {
            try {
                // Fetch plugins and running imports in parallel
                const [pluginsResponse, importsResponse] = await Promise.all([
                    fetch(`${API_BASE}/plugins`),
                    fetch(`${API_BASE}/imports?limit=100`).catch(() => null) // Don't fail if this fails
                ]);
                
                if (!pluginsResponse.ok) {
                    throw new Error(`HTTP error! status: ${pluginsResponse.status}`);
                }
                const plugins = await pluginsResponse.json();
                
                // Get running imports to show progress
                let runningImports = {};
                if (importsResponse && importsResponse.ok) {
                    const imports = await importsResponse.json();
                    // Find the most recent running import for each plugin
                    imports.filter(imp => imp.status === 'running').forEach(imp => {
                        if (!runningImports[imp.plugin_name] || 
                            new Date(imp.started_at) > new Date(runningImports[imp.plugin_name].started_at)) {
                            runningImports[imp.plugin_name] = imp;
                        }
                    });
                }
                
                // Clear existing plugin pollers
                activePluginPollers.forEach(interval => clearInterval(interval));
                activePluginPollers.clear();
                
                // Debug: log plugins data
                console.log('Plugins data:', plugins);
                console.log('Running imports:', runningImports);
                
                if (!plugins || plugins.length === 0) {
                    document.getElementById('plugins-list').innerHTML = '<p>No plugins found.</p>';
                    return;
                }
                
                const html = `
                    <div class="plugin-list" style="margin-top: 20px;">
                        ${plugins.map(plugin => {
                            // Format authentication status - always show it
                            let authStatusText = 'Unknown';
                            let authStatusColor = '#666';
                            let authTimeText = '';
                            
                            // Default to not_authenticated if status is missing
                            const authStatus = plugin.auth_status || 'not_authenticated';
                            
                            if (authStatus === 'authenticated') {
                                authStatusText = '‚úì Authenticated';
                                authStatusColor = '#28a745';
                            } else if (authStatus === 'expired') {
                                authStatusText = '‚ö† Token Expired (can refresh)';
                                authStatusColor = '#ffc107';
                            } else if (authStatus === 'invalid') {
                                authStatusText = '‚úó Invalid Token';
                                authStatusColor = '#dc3545';
                            } else if (authStatus === 'not_authenticated') {
                                authStatusText = 'Not Authenticated';
                                authStatusColor = '#6c757d';
                            } else if (authStatus === 'unknown') {
                                authStatusText = 'Unknown Status';
                                authStatusColor = '#6c757d';
                            }
                            
                            if (plugin.last_auth_time) {
                                // Ensure ISO string has timezone info
                                let isoString = plugin.last_auth_time;
                                if (!isoString.endsWith('Z') && !isoString.match(/[+-]\d{2}:\d{2}$/)) {
                                    isoString = isoString + 'Z'; // Assume UTC if no timezone specified
                                }
                                
                                const authDate = new Date(isoString);
                                const now = new Date();
                                const diffMs = now.getTime() - authDate.getTime();
                                const diffMins = Math.floor(diffMs / 60000);
                                const diffHours = Math.floor(diffMs / 3600000);
                                const diffDays = Math.floor(diffMs / 86400000);
                                
                                let timeAgo = '';
                                if (diffMins < 1) {
                                    timeAgo = 'just now';
                                } else if (diffMins < 60) {
                                    timeAgo = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                                } else if (diffHours < 24) {
                                    timeAgo = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                                } else {
                                    timeAgo = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
                                }
                                
                                const formattedDate = authDate.toLocaleString(undefined, {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    timeZoneName: 'short'
                                });
                                authTimeText = `<p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Last authenticated: ${formattedDate} (${timeAgo})</p>`;
                            }
                            
                            const authInfo = `
                                <div style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid ${authStatusColor};">
                                    <p style="margin: 0; font-size: 13px; font-weight: 600; color: ${authStatusColor};">
                                        ${authStatusText}
                                    </p>
                                    ${authTimeText}
                                </div>
                            `;
                            
                            // Check if this plugin has a running import
                            const runningImport = runningImports[plugin.name];
                            const hasRunningImport = runningImport && runningImport.status === 'running';
                            
                            // Progress display for running imports
                            let progressHtml = '';
                            if (hasRunningImport) {
                                const progressMsg = runningImport.progress_message || 'Processing...';
                                const progressCount = runningImport.progress_total > 0 
                                    ? ` (${runningImport.progress_current || 0}/${runningImport.progress_total})` 
                                    : '';
                                const progressPercent = runningImport.progress_total > 0 
                                    ? Math.round(((runningImport.progress_current || 0) / runningImport.progress_total) * 100) 
                                    : 0;
                                const progressBar = runningImport.progress_total > 0 
                                    ? `<div class="progress-bar" style="margin-top: 8px;"><div class="progress-fill" style="width: ${progressPercent}%"></div></div>` 
                                    : '';
                                
                                progressHtml = `
                                    <div id="plugin-progress-${plugin.name}" class="import-progress" style="margin: 10px 0; padding: 10px; background: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--accent-color);">
                                        <strong>Import in progress:</strong><br>
                                        ${progressMsg}${progressCount}
                                        ${progressBar}
                                    </div>
                                `;
                            }
                            
                            // Format last import information
                            let lastImportHtml = '';
                            if (plugin.last_import_time) {
                                // Ensure ISO string has timezone info - if it doesn't end with Z or timezone, treat as UTC
                                let isoString = plugin.last_import_time;
                                if (!isoString.endsWith('Z') && !isoString.match(/[+-]\d{2}:\d{2}$/)) {
                                    isoString = isoString + 'Z'; // Assume UTC if no timezone specified
                                }
                                
                                const importDate = new Date(isoString);
                                const now = new Date();
                                
                                // Calculate difference in milliseconds (both dates are in local time after parsing)
                                const diffMs = now.getTime() - importDate.getTime();
                                const diffMins = Math.floor(diffMs / 60000);
                                const diffHours = Math.floor(diffMs / 3600000);
                                const diffDays = Math.floor(diffMs / 86400000);
                                
                                let timeAgo = '';
                                if (diffMins < 1) {
                                    timeAgo = 'just now';
                                } else if (diffMins < 60) {
                                    timeAgo = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                                } else if (diffHours < 24) {
                                    timeAgo = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                                } else {
                                    timeAgo = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
                                }
                                
                                // Format date in user's local timezone
                                const formattedDate = importDate.toLocaleString(undefined, {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    timeZoneName: 'short'
                                });
                                
                                const recordsText = plugin.last_import_records !== null && plugin.last_import_records !== undefined
                                    ? `${plugin.last_import_records} record${plugin.last_import_records !== 1 ? 's' : ''}`
                                    : 'N/A';
                                
                                const totalRecords = plugin.total_records !== null && plugin.total_records !== undefined
                                    ? plugin.total_records
                                    : 0;
                                
                                lastImportHtml = `
                                    <div style="margin: 10px 0; padding: 8px; background: var(--bg-tertiary); border-radius: 4px; border-left: 3px solid var(--accent-color);">
                                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">
                                            <strong style="color: var(--text-primary);">Last Import:</strong><br>
                                            ${formattedDate} (${timeAgo})<br>
                                            <strong style="color: var(--text-primary);">Records in last import:</strong> ${recordsText}<br>
                                            <strong style="color: var(--text-primary);">Total records:</strong> ${totalRecords} record${totalRecords !== 1 ? 's' : ''}
                                        </p>
                                    </div>
                                `;
                            } else {
                                const totalRecords = plugin.total_records !== null && plugin.total_records !== undefined
                                    ? plugin.total_records
                                    : 0;
                                
                                lastImportHtml = `
                                    <div style="margin: 10px 0; padding: 8px; background: var(--bg-tertiary); border-radius: 4px; border-left: 3px solid #6c757d;">
                                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">
                                            <strong style="color: var(--text-primary);">Last Import:</strong> Never<br>
                                            <strong style="color: var(--text-primary);">Total records:</strong> ${totalRecords} record${totalRecords !== 1 ? 's' : ''}
                                        </p>
                                    </div>
                                `;
                            }
                            
                            // Special handling for whatsapp plugin (file upload)
                            if (plugin.name === 'whatsapp') {
                                return `
                                <div class="plugin-card">
                                    <h3>${plugin.nice_name || plugin.name}</h3>
                                    <div class="plugin-toggle">
                                        <label onclick="event.stopPropagation();">
                                            <input type="checkbox" id="toggle-${plugin.name}" ${plugin.enabled ? 'checked' : ''} onchange="togglePlugin('${plugin.name}', this.checked)">
                                            <span style="margin-left: 10px;">Enable Plugin</span>
                                        </label>
                                        <div class="toggle-switch ${plugin.enabled ? 'active' : ''}" onclick="const cb = document.querySelector('#toggle-${plugin.name}'); cb.checked = !cb.checked; togglePlugin('${plugin.name}', cb.checked);">
                                        </div>
                                    </div>
                                    ${lastImportHtml}
                                    ${progressHtml}
                                    <button class="btn" onclick="configureWhatsAppPlugin('${plugin.name}')" style="margin-top: 5px; width: 100%;">
                                        ‚öôÔ∏è Configure
                                    </button>
                                    <div style="margin-top: 10px;">
                                        <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 600;">
                                            Upload WhatsApp Chat Export (ZIP):
                                        </label>
                                        <input type="file" id="file-${plugin.name}" accept=".zip" style="margin-bottom: 10px; font-size: 12px;">
                                        <button class="btn" id="btn-${plugin.name}" onclick="runImportWithFile('${plugin.name}', event)" ${!plugin.enabled || hasRunningImport ? 'disabled' : ''} style="margin-top: 5px; width: 100%;">
                                            ${hasRunningImport ? '<span class="loading"></span> Importing...' : 'Upload & Import'}
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-secondary" data-reset-plugin="${plugin.name}" style="margin-top: 5px; width: 100%; background: #dc3545; color: white; cursor: pointer;">
                                        üóëÔ∏è Clear Data
                                    </button>
                                </div>
                            `;
                            }
                            
                            // Special handling for whoop plugin (configuration)
                            if (plugin.name === 'whoop') {
                                return `
                                <div class="plugin-card">
                                    <h3>${plugin.nice_name || plugin.name}</h3>
                                    <div class="plugin-toggle">
                                        <label onclick="event.stopPropagation();">
                                            <input type="checkbox" id="toggle-${plugin.name}" ${plugin.enabled ? 'checked' : ''} onchange="togglePlugin('${plugin.name}', this.checked)">
                                            <span style="margin-left: 10px;">Enable Plugin</span>
                                        </label>
                                        <div class="toggle-switch ${plugin.enabled ? 'active' : ''}" onclick="const cb = document.querySelector('#toggle-${plugin.name}'); cb.checked = !cb.checked; togglePlugin('${plugin.name}', cb.checked);">
                                        </div>
                                    </div>
                                    ${lastImportHtml}
                                    ${authInfo || ''}
                                    ${progressHtml}
                                    <button class="btn" onclick="configureWhoopPlugin('${plugin.name}')" style="margin-top: 5px; width: 100%;">
                                        ‚öôÔ∏è Configure
                                    </button>
                                    <button class="btn" id="btn-${plugin.name}" onclick="runImport('${plugin.name}')" ${!plugin.enabled || hasRunningImport ? 'disabled' : ''} style="margin-top: 5px; width: 100%;">
                                        ${hasRunningImport ? '<span class="loading"></span> Importing...' : 'Run Import'}
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-reset-plugin="${plugin.name}" style="margin-top: 5px; width: 100%; background: #dc3545; color: white; cursor: pointer;">
                                        üóëÔ∏è Clear Data
                                    </button>
                                </div>
                            `;
                            }
                            
                            // Special handling for slack plugin (configuration)
                            if (plugin.name === 'slack') {
                                return `
                                <div class="plugin-card">
                                    <h3>${plugin.nice_name || plugin.name}</h3>
                                    <div class="plugin-toggle">
                                        <label onclick="event.stopPropagation();">
                                            <input type="checkbox" id="toggle-${plugin.name}" ${plugin.enabled ? 'checked' : ''} onchange="togglePlugin('${plugin.name}', this.checked)">
                                            <span style="margin-left: 10px;">Enable Plugin</span>
                                        </label>
                                        <div class="toggle-switch ${plugin.enabled ? 'active' : ''}" onclick="const cb = document.querySelector('#toggle-${plugin.name}'); cb.checked = !cb.checked; togglePlugin('${plugin.name}', cb.checked);">
                                        </div>
                                    </div>
                                    ${lastImportHtml}
                                    ${authInfo || ''}
                                    ${progressHtml}
                                    <button class="btn" onclick="configureSlackPlugin('${plugin.name}')" style="margin-top: 5px; width: 100%;">
                                        ‚öôÔ∏è Configure
                                    </button>
                                    <button class="btn" onclick="authenticatePlugin('${plugin.name}')" style="margin-top: 5px; width: 100%;">
                                        üîê Authenticate
                                    </button>
                                    <button class="btn" id="btn-${plugin.name}" onclick="runImport('${plugin.name}')" ${!plugin.enabled || hasRunningImport ? 'disabled' : ''} style="margin-top: 5px; width: 100%;">
                                        ${hasRunningImport ? '<span class="loading"></span> Importing...' : 'Run Import'}
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-reset-plugin="${plugin.name}" style="margin-top: 5px; width: 100%; background: #dc3545; color: white; cursor: pointer;">
                                        üóëÔ∏è Clear Data
                                    </button>
                                </div>
                            `;
                            }
                            
                            // Special handling for gmail plugin (configuration)
                            if (plugin.name === 'gmail') {
                                const daysBack = plugin.days_back || 7;
                                const maxResults = plugin.max_results || 100;
                                const query = plugin.query || '';
                                
                                return `
                                <div class="plugin-card">
                                    <h3>${plugin.nice_name || plugin.name}</h3>
                                    <div class="plugin-toggle">
                                        <label onclick="event.stopPropagation();">
                                            <input type="checkbox" id="toggle-${plugin.name}" ${plugin.enabled ? 'checked' : ''} onchange="togglePlugin('${plugin.name}', this.checked)">
                                            <span style="margin-left: 10px;">Enable Plugin</span>
                                        </label>
                                        <div class="toggle-switch ${plugin.enabled ? 'active' : ''}" onclick="const cb = document.querySelector('#toggle-${plugin.name}'); cb.checked = !cb.checked; togglePlugin('${plugin.name}', cb.checked);">
                                        </div>
                                    </div>
                                    ${lastImportHtml}
                                    ${authInfo || ''}
                                    <div style="margin: 10px 0; padding: 8px; background: var(--bg-tertiary); border-radius: 4px;">
                                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">
                                            <strong style="color: var(--text-primary);">Days back:</strong> ${daysBack}<br>
                                            <strong style="color: var(--text-primary);">Max results:</strong> ${maxResults || 'Unlimited'}<br>
                                            ${query ? `<strong style="color: var(--text-primary);">Query:</strong> ${query}` : ''}
                                        </p>
                                    </div>
                                    ${progressHtml}
                                    <button class="btn" onclick="configureGmailPlugin('${plugin.name}')" style="margin-top: 5px; width: 100%;">
                                        ‚öôÔ∏è Configure
                                    </button>
                                    <button class="btn" onclick="authenticatePlugin('${plugin.name}')" style="margin-top: 5px; width: 100%;">
                                        üîê Authenticate
                                    </button>
                                    <button class="btn" id="btn-${plugin.name}" onclick="runImport('${plugin.name}')" ${!plugin.enabled || hasRunningImport ? 'disabled' : ''} style="margin-top: 5px; width: 100%;">
                                        ${hasRunningImport ? '<span class="loading"></span> Importing...' : 'Run Import'}
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-reset-plugin="${plugin.name}" style="margin-top: 5px; width: 100%; background: #dc3545; color: white; cursor: pointer;">
                                        üóëÔ∏è Clear Data
                                    </button>
                                </div>
                            `;
                            }
                            
                            // Special handling for github plugin (configuration)
                            if (plugin.name === 'github') {
                                const tokenConfigured = plugin.token_configured || false;
                                const fileUrls = plugin.file_urls || [];
                                const tokenStatus = tokenConfigured 
                                    ? '<span style="color: #28a745;">‚úì Token configured</span>' 
                                    : '<span style="color: #dc3545;">‚úó Token not configured</span>';
                                const fileCount = fileUrls.length;
                                
                                return `
                                <div class="plugin-card">
                                    <h3>${plugin.nice_name || plugin.name}</h3>
                                    <div class="plugin-toggle">
                                        <label onclick="event.stopPropagation();">
                                            <input type="checkbox" id="toggle-${plugin.name}" ${plugin.enabled ? 'checked' : ''} onchange="togglePlugin('${plugin.name}', this.checked)">
                                            <span style="margin-left: 10px;">Enable Plugin</span>
                                        </label>
                                        <div class="toggle-switch ${plugin.enabled ? 'active' : ''}" onclick="const cb = document.querySelector('#toggle-${plugin.name}'); cb.checked = !cb.checked; togglePlugin('${plugin.name}', cb.checked);">
                                        </div>
                                    </div>
                                    ${lastImportHtml}
                                    <div style="margin: 10px 0; padding: 8px; background: var(--bg-tertiary); border-radius: 4px;">
                                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">
                                            ${tokenStatus}<br>
                                            <strong style="color: var(--text-primary);">Files configured:</strong> ${fileCount}
                                        </p>
                                    </div>
                                    ${progressHtml}
                                    <button class="btn" onclick="configureGitHubPlugin('${plugin.name}')" style="margin-top: 5px; width: 100%;">
                                        ‚öôÔ∏è Configure
                                    </button>
                                    <button class="btn" id="btn-${plugin.name}" onclick="runImport('${plugin.name}')" ${!plugin.enabled || hasRunningImport || !tokenConfigured || fileCount === 0 ? 'disabled' : ''} style="margin-top: 5px; width: 100%;">
                                        ${hasRunningImport ? '<span class="loading"></span> Importing...' : 'Run Import'}
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-reset-plugin="${plugin.name}" style="margin-top: 5px; width: 100%; background: #dc3545; color: white; cursor: pointer;">
                                        üóëÔ∏è Clear Data
                                    </button>
                                </div>
                            `;
                            }
                            
                            return `
                            <div class="plugin-card">
                                <h3>${plugin.nice_name || plugin.name}</h3>
                                <div class="plugin-toggle">
                                    <label onclick="event.stopPropagation();">
                                        <input type="checkbox" id="toggle-${plugin.name}" ${plugin.enabled ? 'checked' : ''} onchange="togglePlugin('${plugin.name}', this.checked)">
                                        <span style="margin-left: 10px;">Enable Plugin</span>
                                    </label>
                                    <div class="toggle-switch ${plugin.enabled ? 'active' : ''}" onclick="const cb = document.querySelector('#toggle-${plugin.name}'); cb.checked = !cb.checked; togglePlugin('${plugin.name}', cb.checked);">
                                    </div>
                                </div>
                                ${lastImportHtml}
                                ${authInfo || ''}
                                ${progressHtml}
                                <button class="btn" onclick="authenticatePlugin('${plugin.name}')" style="margin-top: 5px;">
                                    Authenticate
                                </button>
                                <button class="btn" id="btn-${plugin.name}" onclick="runImport('${plugin.name}')" ${!plugin.enabled || hasRunningImport ? 'disabled' : ''} style="margin-top: 5px;">
                                    ${hasRunningImport ? '<span class="loading"></span> Importing...' : 'Run Import'}
                                </button>
                                <button type="button" class="btn btn-secondary" data-reset-plugin="${plugin.name}" style="margin-top: 5px; background: #dc3545; color: white; cursor: pointer;">
                                    üóëÔ∏è Clear Data
                                </button>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
                document.getElementById('plugins-list').innerHTML = html;
                
                // Start polling for running imports
                Object.entries(runningImports).forEach(([pluginName, importData]) => {
                    if (importData.status === 'running') {
                        startPluginProgressPolling(pluginName, importData.id);
                    }
                });
            } catch (error) {
                console.error('Error loading plugins:', error);
                document.getElementById('plugins-list').innerHTML = `<p style="color: red;">Error loading plugins: ${error.message}</p>`;
            }
        }
        
        function startPluginProgressPolling(pluginName, logId) {
            // Clear any existing poller for this plugin
            if (activePluginPollers.has(pluginName)) {
                clearInterval(activePluginPollers.get(pluginName));
            }
            
            const pollInterval = setInterval(async () => {
                try {
                    const statusResponse = await apiFetch(`${API_BASE}/imports/${logId}/status`);
                    if (!statusResponse.ok) {
                        clearInterval(pollInterval);
                        activePluginPollers.delete(pluginName);
                        return;
                    }
                    
                    const status = await statusResponse.json();
                    const progressElement = document.getElementById(`plugin-progress-${pluginName}`);
                    const buttonElement = document.getElementById(`btn-${pluginName}`);
                    
                    if (progressElement) {
                        const progressMsg = status.progress_message || 'Processing...';
                        const progressCount = status.progress_total > 0 
                            ? ` (${status.progress_current || 0}/${status.progress_total})` 
                            : '';
                        const progressPercent = status.progress_total > 0 
                            ? Math.round(((status.progress_current || 0) / status.progress_total) * 100) 
                            : 0;
                        const progressBar = status.progress_total > 0 
                            ? `<div class="progress-bar" style="margin-top: 8px;"><div class="progress-fill" style="width: ${progressPercent}%"></div></div>` 
                            : '';
                        
                        progressElement.innerHTML = `
                            <strong>Import in progress:</strong><br>
                            ${progressMsg}${progressCount}
                            ${progressBar}
                        `;
                    }
                    
                    if (buttonElement) {
                        if (status.progress_total > 0) {
                            const percent = status.progress_percent || 0;
                            buttonElement.innerHTML = `<span class="loading"></span> ${status.progress_message || 'Processing...'} (${percent}%)`;
                        } else {
                            buttonElement.innerHTML = `<span class="loading"></span> ${status.progress_message || 'Processing...'}`;
                        }
                        buttonElement.disabled = true;
                    }
                    
                    // Stop polling if import is complete
                    if (status.status === 'success' || status.status === 'error') {
                        clearInterval(pollInterval);
                        activePluginPollers.delete(pluginName);
                        
                        // Reload plugins to show final state
                        setTimeout(() => loadPlugins(), 1000);
                    }
                } catch (error) {
                    console.error(`Error polling plugin ${pluginName} import:`, error);
                }
            }, 1000); // Poll every second
            
            activePluginPollers.set(pluginName, pollInterval);
        }
        
        async function runImportWithFile(pluginName, event) {
            const fileInput = document.getElementById(`file-${pluginName}`);
            const file = fileInput?.files[0];
            
            if (!file) {
                alert('Please select a ZIP file to upload');
                return;
            }
            
            if (!file.name.endsWith('.zip')) {
                alert('Please upload a ZIP file');
                return;
            }
            
            // Get button element - try event.target first, then fall back to ID
            const btn = (event && event.target) ? event.target : document.getElementById(`btn-${pluginName}`);
            if (!btn) {
                console.error(`Could not find button for plugin ${pluginName}`);
                alert('Error: Could not find import button');
                return;
            }
            
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Uploading...';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('plugin_name', pluginName);
                
                // Start the import with file upload
                const response = await apiFetch(`${API_BASE}/imports/run`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (!result.success || !result.log_id) {
                    alert(`Error starting import: ${result.error || 'Unknown error'}`);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }
                
                const logId = result.log_id;
                
                // Use centralized polling system so progress persists when navigating away
                startPluginProgressPolling(pluginName, logId);
                
                // Also update button immediately
                btn.innerHTML = '<span class="loading"></span> Starting...';
                
                // Reload plugins to show progress display
                setTimeout(() => loadPlugins(), 500);
                
            } catch (error) {
                console.error('Error starting import:', error);
                alert(`Error: ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        async function runImport(pluginName) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Starting...';
            
            try {
                // Start the import
                const response = await apiFetch(`${API_BASE}/imports/run`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({plugin_name: pluginName})
                });
                
                const result = await response.json();
                
                if (!result.success || !result.log_id) {
                    alert(`Error starting import: ${result.error || 'Unknown error'}`);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }
                
                const logId = result.log_id;
                
                // Use centralized polling system so progress persists when navigating away
                startPluginProgressPolling(pluginName, logId);
                
                // Also update button immediately
                btn.innerHTML = '<span class="loading"></span> Starting...';
                
                // Reload plugins to show progress display
                setTimeout(() => loadPlugins(), 500);
                
            } catch (error) {
                console.error('Error starting import:', error);
                alert(`Error: ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        async function runAllImports() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Starting all imports...';
            
            try {
                const response = await apiFetch(`${API_BASE}/imports/run`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    alert(`Error starting imports: ${result.error || 'Unknown error'}`);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }
                
                // For "run all", we just show a message and refresh
                btn.innerHTML = '<span class="loading"></span> All imports started...';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    loadImports();
                }, 2000);
            } catch (error) {
                console.error('Error starting all imports:', error);
                alert(`Error: ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show temporary feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#007bff';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }
        
        async function configureGitHubPlugin(pluginName) {
            try {
                // Fetch current configuration
                const configResponse = await apiFetch(`${API_BASE}/plugins/${pluginName}/config`);
                if (!configResponse.ok) {
                    throw new Error('Failed to load plugin configuration');
                }
                const config = await configResponse.json();
                
                // Create modal dialog
                const modal = document.createElement('div');
                modal.id = 'github-config-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                const fileUrls = config.file_urls || [];
                const fileUrlsText = fileUrls.join('\n');
                
                modal.innerHTML = `
                    <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h2 style="margin-top: 0; color: var(--text-primary);">Configure GitHub Context Plugin</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                                GitHub Personal Access Token:
                            </label>
                            <input 
                                type="password" 
                                id="github-token-input" 
                                placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary); font-family: monospace;"
                            />
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Create a token at <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--accent-color);">github.com/settings/tokens</a> with <code>repo</code> scope
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                                File URLs (one per line):
                            </label>
                            <textarea 
                                id="github-urls-input" 
                                placeholder="https://github.com/owner/repo/blob/branch/path/file.txt&#10;https://github.com/owner/repo/blob/main/another/file.txt"
                                style="width: 100%; min-height: 200px; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary); font-family: monospace; font-size: 12px; resize: vertical;"
                            >${fileUrlsText}</textarea>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Enter GitHub file URLs, one per line. Format: <code>https://github.com/owner/repo/blob/branch/path/file.txt</code>
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeGitHubConfigModal()" style="padding: 10px 20px;">
                                Cancel
                            </button>
                            <button class="btn btn-primary" onclick="saveGitHubConfig('${pluginName}')" style="padding: 10px 20px;">
                                Save Configuration
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeGitHubConfigModal();
                    }
                });
                
            } catch (error) {
                console.error('Error opening GitHub configuration:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        function closeGitHubConfigModal() {
            const modal = document.getElementById('github-config-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function saveGitHubConfig(pluginName) {
            try {
                const tokenInput = document.getElementById('github-token-input');
                const urlsInput = document.getElementById('github-urls-input');
                
                if (!tokenInput || !urlsInput) {
                    throw new Error('Configuration form not found');
                }
                
                const token = tokenInput.value.trim();
                const urlsText = urlsInput.value.trim();
                
                // Parse URLs (split by newline, filter empty lines)
                const fileUrls = urlsText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                // Validate URLs
                const urlPattern = /^https:\/\/github\.com\/[^\/]+\/[^\/]+\/blob\/[^\/]+\/.+$/;
                const invalidUrls = fileUrls.filter(url => !urlPattern.test(url));
                if (invalidUrls.length > 0) {
                    alert(`Invalid URL format:\n${invalidUrls.join('\n')}\n\nExpected format: https://github.com/owner/repo/blob/branch/path/file.txt`);
                    return;
                }
                
                // Prepare config data
                const configData = {
                    file_urls: fileUrls
                };
                
                // Add token if provided
                if (token) {
                    configData.github_token = token;
                }
                
                // Save configuration
                const response = await apiFetch(`${API_BASE}/plugins/${pluginName}/config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(configData)
                });
                
                if (!response.ok) {
                    // Try to parse as JSON, but handle HTML error pages
                    let errorMessage = 'Failed to save configuration';
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const error = await response.json();
                            errorMessage = error.error || errorMessage;
                        } else {
                            const text = await response.text();
                            errorMessage = `Server error (${response.status}): ${text.substring(0, 200)}`;
                        }
                    } catch (e) {
                        errorMessage = `HTTP error ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                
                // Close modal and reload plugins
                closeGitHubConfigModal();
                loadPlugins();
                
                alert('Configuration saved successfully!');
                
            } catch (error) {
                console.error('Error saving GitHub configuration:', error);
                alert(`Error saving configuration: ${error.message}`);
            }
        }
        
        async function configureGmailPlugin(pluginName) {
            try {
                // Fetch current configuration
                const configResponse = await apiFetch(`${API_BASE}/plugins/${pluginName}/config`);
                if (!configResponse.ok) {
                    throw new Error('Failed to load plugin configuration');
                }
                const config = await configResponse.json();
                
                // Create modal dialog
                const modal = document.createElement('div');
                modal.id = 'gmail-config-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                const daysBack = config.days_back || 7;
                const maxResults = config.max_results || 100;
                const query = config.query || '';
                
                modal.innerHTML = `
                    <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h2 style="margin-top: 0; color: var(--text-primary);">Configure Gmail Plugin</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                                Days Back:
                            </label>
                            <input 
                                type="number" 
                                id="gmail-days-back-input" 
                                value="${daysBack}"
                                min="1"
                                max="365"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);"
                            />
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Number of days to look back for emails (1-365)
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                                Max Results:
                            </label>
                            <input 
                                type="number" 
                                id="gmail-max-results-input" 
                                value="${maxResults}"
                                min="0"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);"
                            />
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Maximum number of emails to fetch (0 = unlimited)
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                                Gmail Search Query (optional):
                            </label>
                            <input 
                                type="text" 
                                id="gmail-query-input" 
                                value="${query}"
                                placeholder="e.g., is:unread, from:example@gmail.com"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);"
                            />
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Optional Gmail search query to filter emails. See <a href="https://support.google.com/mail/answer/7190" target="_blank" style="color: var(--accent-color);">Gmail search operators</a>
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeGmailConfigModal()" style="padding: 10px 20px;">
                                Cancel
                            </button>
                            <button class="btn btn-primary" onclick="saveGmailConfig('${pluginName}')" style="padding: 10px 20px;">
                                Save Configuration
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeGmailConfigModal();
                    }
                });
                
            } catch (error) {
                console.error('Error opening Gmail configuration:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        function closeGmailConfigModal() {
            const modal = document.getElementById('gmail-config-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function saveGmailConfig(pluginName) {
            try {
                const daysBackInput = document.getElementById('gmail-days-back-input');
                const maxResultsInput = document.getElementById('gmail-max-results-input');
                const queryInput = document.getElementById('gmail-query-input');
                
                if (!daysBackInput || !maxResultsInput || !queryInput) {
                    throw new Error('Configuration form not found');
                }
                
                const daysBack = parseInt(daysBackInput.value.trim()) || 7;
                const maxResults = parseInt(maxResultsInput.value.trim()) || 0;
                const query = queryInput.value.trim();
                
                // Validate inputs
                if (daysBack < 1 || daysBack > 365) {
                    alert('Days back must be between 1 and 365');
                    return;
                }
                
                if (maxResults < 0) {
                    alert('Max results must be 0 or greater (0 = unlimited)');
                    return;
                }
                
                // Prepare config data
                const configData = {
                    days_back: daysBack,
                    max_results: maxResults,
                    query: query
                };
                
                // Save configuration
                const response = await apiFetch(`${API_BASE}/plugins/${pluginName}/config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(configData)
                });
                
                if (!response.ok) {
                    let errorMessage = 'Failed to save configuration';
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const error = await response.json();
                            errorMessage = error.error || errorMessage;
                        } else {
                            const text = await response.text();
                            errorMessage = `Server error (${response.status}): ${text.substring(0, 200)}`;
                        }
                    } catch (e) {
                        errorMessage = `HTTP error ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                
                // Close modal and reload plugins
                closeGmailConfigModal();
                loadPlugins();
                
                alert('Configuration saved successfully!');
                
            } catch (error) {
                console.error('Error saving Gmail configuration:', error);
                alert(`Error saving configuration: ${error.message}`);
            }
        }
        
        async function configureWhatsAppPlugin(pluginName) {
            try {
                // Fetch current configuration
                const configResponse = await apiFetch(`${API_BASE}/plugins/${pluginName}/config`);
                if (!configResponse.ok) {
                    throw new Error('Failed to load plugin configuration');
                }
                const config = await configResponse.json();
                
                // Create modal dialog
                const modal = document.createElement('div');
                modal.id = 'whatsapp-config-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h2 style="margin-top: 0; color: var(--text-primary);">Configure WhatsApp Plugin</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="color: var(--text-secondary);">
                                Configuration options for WhatsApp plugin will be available here.
                            </p>
                            <p style="color: var(--text-secondary); font-size: 14px; margin-top: 10px;">
                                Currently, you can upload WhatsApp chat exports (ZIP files) directly from the plugin card.
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeWhatsAppConfigModal()" style="padding: 10px 20px;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeWhatsAppConfigModal();
                    }
                });
                
            } catch (error) {
                console.error('Error opening WhatsApp configuration:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        function closeWhatsAppConfigModal() {
            const modal = document.getElementById('whatsapp-config-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function configureWhoopPlugin(pluginName) {
            try {
                // Fetch current configuration
                const configResponse = await apiFetch(`${API_BASE}/plugins/${pluginName}/config`);
                if (!configResponse.ok) {
                    throw new Error('Failed to load plugin configuration');
                }
                const config = await configResponse.json();
                
                // Create modal dialog
                const modal = document.createElement('div');
                modal.id = 'whoop-config-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h2 style="margin-top: 0; color: var(--text-primary);">Configure WHOOP Plugin</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="color: var(--text-secondary);">
                                Configuration options for WHOOP plugin will be available here.
                            </p>
                            <p style="color: var(--text-secondary); font-size: 14px; margin-top: 10px;">
                                Currently, the plugin uses default settings from the configuration file.
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeWhoopConfigModal()" style="padding: 10px 20px;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeWhoopConfigModal();
                    }
                });
                
            } catch (error) {
                console.error('Error opening WHOOP configuration:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        function closeWhoopConfigModal() {
            const modal = document.getElementById('whoop-config-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function configureSlackPlugin(pluginName) {
            try {
                // Fetch current configuration
                const configResponse = await apiFetch(`${API_BASE}/plugins/${pluginName}/config`);
                if (!configResponse.ok) {
                    throw new Error('Failed to load plugin configuration');
                }
                const config = await configResponse.json();
                
                // Create modal dialog
                const modal = document.createElement('div');
                modal.id = 'slack-config-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h2 style="margin-top: 0; color: var(--text-primary);">Configure Slack Plugin</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="color: var(--text-secondary);">
                                Configuration options for Slack plugin will be available here.
                            </p>
                            <p style="color: var(--text-secondary); font-size: 14px; margin-top: 10px;">
                                Currently, the plugin uses default settings from the configuration file.
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeSlackConfigModal()" style="padding: 10px 20px;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeSlackConfigModal();
                    }
                });
                
            } catch (error) {
                console.error('Error opening Slack configuration:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        function closeSlackConfigModal() {
            const modal = document.getElementById('slack-config-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function togglePlugin(pluginName, enabled) {
            try {
                const response = await apiFetch(`${API_BASE}/plugins/${pluginName}/toggle`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ enabled: enabled })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to toggle plugin');
                }
                
                const result = await response.json();
                
                // Update the toggle switch visual state
                const pluginCard = document.querySelector(`#toggle-${pluginName}`)?.closest('.plugin-card');
                if (pluginCard) {
                    const toggleSwitch = pluginCard.querySelector('.toggle-switch');
                    if (toggleSwitch) {
                        if (enabled) {
                            toggleSwitch.classList.add('active');
                        } else {
                            toggleSwitch.classList.remove('active');
                        }
                    }
                }
                
                // Reload plugins to update the UI (buttons, etc.)
                loadPlugins();
                
            } catch (error) {
                console.error('Error toggling plugin:', error);
                alert(`Error: ${error.message}`);
                // Reload to reset the toggle state
                loadPlugins();
            }
        }
        
        async function authenticatePlugin(pluginName) {
            try {
                const response = await apiFetch(`${API_BASE}/plugins/${pluginName}/auth/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Authentication failed: ${error.error || 'Unknown error'}`);
                    return;
                }
                
                const data = await response.json();
                const authUrl = data.authorization_url;
                
                // Show redirect URI info if provided
                if (data.redirect_uri) {
                    console.log('Redirect URI:', data.redirect_uri);
                    if (data.instructions) {
                        console.log(data.instructions);
                    }
                }
                
                // Open authorization URL in a popup window
                const width = 600;
                const height = 700;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                
                const popup = window.open(
                    authUrl,
                    'OAuth Authentication',
                    `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
                );
                
                // Listen for OAuth success message from popup
                const messageListener = function(event) {
                    if (event.data && event.data.type === 'oauth_success' && event.data.plugin === pluginName) {
                        window.removeEventListener('message', messageListener);
                        popup.close();
                        alert('Authentication successful! You can now run imports.');
                        // Optionally refresh the page or update UI
                        loadPlugins();
                    }
                };
                
                window.addEventListener('message', messageListener);
                
                // Check if popup was blocked
                if (!popup || popup.closed || typeof popup.closed === 'undefined') {
                    alert('Popup was blocked. Please allow popups for this site and try again.');
                }
            } catch (error) {
                console.error('Error starting authentication:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        async function reuploadToVectorStore() {
            if (!confirm('This will re-upload all data from your database to the vector store. This may take a while. Continue?')) {
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Re-uploading...';
            
            try {
                const response = await apiFetch(`${API_BASE}/vector-store/reupload`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úì Success! Re-uploaded ${data.total_uploaded} items to vector store.\n\nResults:\n${Object.entries(data.results).map(([plugin, info]) => `- ${plugin}: ${info.uploaded}/${info.total_items} items`).join('\n')}`);
                    btn.innerHTML = '‚úì Complete';
                    btn.style.background = '#28a745';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.background = '#17a2b8';
                    }, 3000);
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error re-uploading to vector store:', error);
                alert(`‚ùå Error: ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        async function loadStats() {
            try {
                const [statsResponse, vectorStoreResponse] = await Promise.all([
                    fetch(`${API_BASE}/stats`),
                    fetch(`${API_BASE}/vector-store/info`).catch(() => null) // Don't fail if vector store not available
                ]);
                
                if (!statsResponse.ok) {
                    throw new Error(`HTTP error! status: ${statsResponse.status}`);
                }
                const stats = await statsResponse.json();
                
                let vectorStoreInfo = null;
                if (vectorStoreResponse && vectorStoreResponse.ok) {
                    vectorStoreInfo = await vectorStoreResponse.json();
                }
                
                const html = `
                    <div style="margin-top: 20px;">
                        <h3>Total Items: ${stats.total_items || 0}</h3>
                        <h3 style="margin-top: 20px;">Database Size: ${stats.database_size || '0 B'}</h3>
                        ${vectorStoreInfo ? `
                            <div style="margin-top: 20px; padding: 15px; background: ${vectorStoreInfo.file_count > 0 ? '#d4edda' : '#fff3cd'}; border-radius: 4px; border: 1px solid ${vectorStoreInfo.file_count > 0 ? '#c3e6cb' : '#ffc107'};">
                                <h3 style="margin-top: 0;">Vector Store Status</h3>
                                <p><strong>Files in Vector Store:</strong> ${vectorStoreInfo.file_count}</p>
                                <p><strong>Vector Store Size:</strong> ${vectorStoreInfo.total_size || '0 B'}</p>
                                <p><strong>Status:</strong> ${vectorStoreInfo.status || 'unknown'}</p>
                                ${vectorStoreInfo.file_count === 0 ? '<p style="color: #856404; margin-top: 10px;"><strong>‚ö†Ô∏è No files in vector store!</strong> Click "Re-upload All Data to Vector Store" to upload your data.</p>' : ''}
                            </div>
                        ` : `
                            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
                                <h3 style="margin-top: 0;">Vector Store Status</h3>
                                <p style="color: #856404;"><strong>‚ö†Ô∏è Vector store not available.</strong> Make sure OPENAI_API_KEY is set and try re-uploading your data.</p>
                            </div>
                        `}
                        <h3 style="margin-top: 20px;">By Plugin:</h3>
                        <ul>
                            ${Object.keys(stats.by_plugin || {}).length > 0 
                                ? Object.entries(stats.by_plugin).map(([plugin, count]) => 
                                    `<li>${plugin}: ${count}</li>`
                                ).join('')
                                : '<li>No data yet</li>'
                            }
                        </ul>
                        <h3 style="margin-top: 20px;">By Type:</h3>
                        <ul>
                            ${Object.keys(stats.by_type || {}).length > 0
                                ? Object.entries(stats.by_type).map(([type, count]) => 
                                    `<li>${type}: ${count}</li>`
                                ).join('')
                                : '<li>No data yet</li>'
                            }
                        </ul>
                    </div>
                `;
                document.getElementById('stats-content').innerHTML = html;
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats-content').innerHTML = `<p style="color: red;">Error loading stats: ${error.message}</p>`;
            }
        }
        
        async function exportEmails() {
            try {
                const response = await apiFetch(`${API_BASE}/export/emails`);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP error! status: ${response.status}`);
                }
                
                // Get filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'emails_export.txt';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success message
                alert(`‚úÖ Successfully exported emails to ${filename}`);
            } catch (error) {
                console.error('Error exporting emails:', error);
                alert(`‚ùå Error exporting emails: ${error.message}`);
            }
        }
        
        async function exportWhoop() {
            try {
                const response = await apiFetch(`${API_BASE}/export/whoop`);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP error! status: ${response.status}`);
                }
                
                // Get filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'whoop_export.txt';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success message
                alert(`‚úÖ Successfully exported WHOOP data to ${filename}`);
            } catch (error) {
                console.error('Error exporting WHOOP data:', error);
                alert(`‚ùå Error exporting WHOOP data: ${error.message}`);
            }
        }
        
        let currentThreadId = null;
        let allThreads = [];
        
        async function initChat() {
            // Load and display current model
            loadChatModel();
            try {
                // Load all threads
                await loadChatThreads();
                
                // Try to restore last thread from localStorage
                const savedThreadId = localStorage.getItem('currentThreadId');
                if (savedThreadId && allThreads.find(t => t.thread_id === savedThreadId)) {
                    await switchToThread(savedThreadId);
                } else if (allThreads.length > 0) {
                    // Load most recent thread
                    await switchToThread(allThreads[0].thread_id);
                } else {
                    // Create new thread if none exist
                    await newChatThread();
                }
                
                // Ensure title is updated after initialization
                updateThreadTitle();
            } catch (error) {
                console.error('Error initializing chat:', error);
                // If initialization fails, try to create a new thread
                await newChatThread();
            }
        }
        
        function updateThreadTitle() {
            if (!currentThreadId) return;
            
            const thread = allThreads.find(t => t.thread_id === currentThreadId);
            const title = thread ? (thread.title || 'New Conversation') : 'New Conversation';
            
            const desktopTitle = document.getElementById('chat-thread-title');
            if (desktopTitle) {
                desktopTitle.textContent = title;
            }
            
            const mobileTitle = document.getElementById('chat-thread-title-mobile');
            if (mobileTitle) {
                mobileTitle.textContent = title;
                console.log('Updated mobile title to:', title);
            } else {
                console.warn('Mobile title element not found!');
            }
        }
        
        async function loadChatThreads() {
            try {
                const response = await apiFetch(`${API_BASE}/chat/threads`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allThreads = data.threads || [];
                console.log('Loaded threads:', allThreads.length, allThreads);
                renderThreadsList();
                
                // Update thread title if we have a current thread
                updateThreadTitle();
            } catch (error) {
                console.error('Error loading chat threads:', error);
                allThreads = [];
                renderThreadsList();
            }
        }
        
        function renderThreadsList() {
            // Render in chat threads sidebar (left side)
            const threadsList = document.getElementById('chat-threads-list');
            if (threadsList) {
                if (allThreads.length === 0) {
                    threadsList.innerHTML = '<div style="padding: 16px; color: var(--text-secondary); font-size: 13px; text-align: center;">No conversations yet</div>';
                } else {
                    threadsList.innerHTML = allThreads.map(thread => {
                        const isActive = thread.thread_id === currentThreadId;
                        const date = thread.updated_at ? new Date(thread.updated_at) : new Date(thread.created_at);
                        const timeStr = formatRelativeTime(date);
                        
                        return `
                            <div class="chat-thread-item ${isActive ? 'active' : ''}" onclick="switchToThread('${thread.thread_id}')">
                                <div class="chat-thread-content">
                                    <div class="chat-thread-title">${escapeHtml(thread.title || 'New Chat')}</div>
                                    <div class="chat-thread-time">${timeStr}</div>
                                </div>
                                <div class="chat-thread-delete" onclick="event.stopPropagation(); deleteChatThread('${thread.thread_id}')" title="Delete conversation">
                                    üóëÔ∏è
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            // Render in main sidebar (right side)
            const sidebarThreadsList = document.getElementById('sidebar-threads-list');
            if (sidebarThreadsList) {
                if (allThreads.length === 0) {
                    sidebarThreadsList.innerHTML = '<div style="padding: 8px 12px; color: var(--text-secondary); font-size: 12px; text-align: center;">No conversations yet</div>';
                } else {
                    sidebarThreadsList.innerHTML = allThreads.map(thread => {
                        const isActive = thread.thread_id === currentThreadId;
                        const date = thread.updated_at ? new Date(thread.updated_at) : new Date(thread.created_at);
                        const timeStr = formatRelativeTime(date);
                        
                        return `
                            <div class="sidebar-thread-item ${isActive ? 'active' : ''}" onclick="switchToThread('${thread.thread_id}'); showTab('chat');">
                                <div class="sidebar-thread-content">
                                    <div class="sidebar-thread-title">${escapeHtml(thread.title || 'New Chat')}</div>
                                    <div class="sidebar-thread-time">${timeStr}</div>
                                </div>
                                <div class="sidebar-thread-delete" onclick="event.stopPropagation(); deleteChatThread('${thread.thread_id}')" title="Delete conversation">
                                    üóëÔ∏è
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now.getTime() - date.getTime();
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function switchToThread(threadId) {
            currentThreadId = threadId;
            localStorage.setItem('currentThreadId', threadId);
            
            // Update UI
            updateThreadTitle();
            
            renderThreadsList();
            await loadChatMessages();
        }
        
        async function deleteChatThread(threadId) {
            if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE}/chat/threads/${threadId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP error! status: ${response.status}`);
                }
                
                // If we deleted the current thread, switch to another one or create new
                if (threadId === currentThreadId) {
                    // Remove from allThreads
                    allThreads = allThreads.filter(t => t.thread_id !== threadId);
                    
                    if (allThreads.length > 0) {
                        // Switch to the most recent thread
                        await switchToThread(allThreads[0].thread_id);
                    } else {
                        // Create a new thread if none exist
                        currentThreadId = null;
                        localStorage.removeItem('currentThreadId');
                        await newChatThread();
                    }
                } else {
                    // Just remove from list
                    allThreads = allThreads.filter(t => t.thread_id !== threadId);
                    renderThreadsList();
                }
            } catch (error) {
                console.error('Error deleting thread:', error);
                alert('Failed to delete conversation: ' + error.message);
            }
        }
        
        async function newChatThread() {
            try {
                const response = await apiFetch(`${API_BASE}/chat/threads`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                currentThreadId = data.thread_id;
                localStorage.setItem('currentThreadId', currentThreadId);
                
                // Reload threads list
                await loadChatThreads();
                
                // Switch to new thread
                await switchToThread(currentThreadId);
                
                return currentThreadId;
            } catch (error) {
                console.error('Error creating chat thread:', error);
                alert(`Error creating chat thread: ${error.message}`);
                return null;
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) {
                return;
            }
            
            if (!currentThreadId) {
                await newChatThread();
                if (!currentThreadId) {
                    return;
                }
            }
            
            const messagesDiv = document.getElementById('chat-messages');
            
            // Remove empty state if present
            const emptyState = messagesDiv.querySelector('.chat-empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            // Add user message to UI with ChatGPT-style structure
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message';
            userMessageDiv.innerHTML = `
                <div class="message-avatar user">U</div>
                <div class="message-content user">${message.replace(/\n/g, '<br>')}</div>
            `;
            messagesDiv.appendChild(userMessageDiv);
            
            // Clear input and reset height
            input.value = '';
            input.style.height = 'auto';
            input.disabled = true;
            document.getElementById('chat-send-btn').disabled = true;
            
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'chat-loading';
            loadingDiv.className = 'chat-message';
            loadingDiv.innerHTML = `
                <div class="message-avatar assistant">AI</div>
                <div class="message-content assistant">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                const response = await apiFetch(`${API_BASE}/chat/threads/${currentThreadId}/messages`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: message
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Reload threads to update timestamp
                await loadChatThreads();
                
                // Remove loading indicator
                loadingDiv.remove();
                
                // Add assistant response with ChatGPT-style structure
                const assistantMessageDiv = document.createElement('div');
                assistantMessageDiv.className = 'chat-message';
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content assistant markdown-content';
                messageContent.innerHTML = renderMarkdown(data.response);
                assistantMessageDiv.innerHTML = `
                    <div class="message-avatar assistant">AI</div>
                `;
                assistantMessageDiv.appendChild(messageContent);
                messagesDiv.appendChild(assistantMessageDiv);
                
                // Highlight code blocks if hljs is available (after DOM update)
                if (typeof hljs !== 'undefined') {
                    setTimeout(() => {
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            if (!block.classList.contains('hljs')) {
                                hljs.highlightElement(block);
                            }
                        });
                    }, 0);
                }
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
            } catch (error) {
                console.error('Error sending message:', error);
                loadingDiv.remove();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message';
                errorDiv.innerHTML = `
                    <div class="message-avatar assistant">AI</div>
                    <div class="message-content assistant" style="color: #e74c3c;">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
                messagesDiv.appendChild(errorDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } finally {
                input.disabled = false;
                document.getElementById('chat-send-btn').disabled = false;
                input.focus();
            }
        }
        
        async function loadChatMessages() {
            if (!currentThreadId) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE}/chat/threads/${currentThreadId}/messages`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // Thread not found, clear it and create a new one
                        console.warn('Thread not found, creating new thread');
                        currentThreadId = null;
                        localStorage.removeItem('currentThreadId');
                        await newChatThread();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = ''; // Clear existing messages
                
                if (data.messages.length === 0) {
                    messagesDiv.innerHTML = `
                        <div class="chat-empty-state">
                            <h2>How can I help you today?</h2>
                            <p>Ask questions about your imported data from Gmail, WhatsApp, WHOOP, and more.</p>
                        </div>
                    `;
                    return;
                }
                
                messagesDiv.innerHTML = '';
                data.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'chat-message';
                    
                    const avatar = document.createElement('div');
                    avatar.className = `message-avatar ${msg.role}`;
                    avatar.textContent = msg.role === 'user' ? 'U' : 'AI';
                    
                    const messageContent = document.createElement('div');
                    messageContent.className = `message-content ${msg.role}`;
                    
                    if (msg.role === 'assistant') {
                        // Render assistant messages with markdown
                        messageContent.classList.add('markdown-content');
                        messageContent.innerHTML = renderMarkdown(msg.content);
                    } else {
                        // User messages remain plain text (or simple line breaks)
                        messageContent.innerHTML = msg.content.replace(/\n/g, '<br>');
                    }
                    
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(messageContent);
                    messagesDiv.appendChild(messageDiv);
                    
                    // Highlight code blocks for assistant messages (after DOM update)
                    if (msg.role === 'assistant' && typeof hljs !== 'undefined') {
                        setTimeout(() => {
                            messageContent.querySelectorAll('pre code').forEach((block) => {
                                if (!block.classList.contains('hljs')) {
                                    hljs.highlightElement(block);
                                }
                            });
                        }, 0);
                    }
                });
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        async function resetPlugin(pluginName) {
            console.log('resetPlugin called for:', pluginName);
            
            // Confirmation
            const confirmed = confirm(`‚ö†Ô∏è WARNING: This will delete ALL data for the "${pluginName}" plugin.\n\nThis includes:\n- All imported data items\n- All import logs\n\nThis action CANNOT be undone.\n\nAre you sure you want to reset this plugin?`);
            if (!confirmed) {
                console.log('Reset cancelled by user');
                return;
            }
            
            console.log('User confirmed reset, sending request...');
            
            try {
                const url = `${API_BASE}/plugins/${pluginName}/reset`;
                console.log('Calling:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({confirm: true})
                });
                
                console.log('Response status:', response.status);
                
                let data;
                try {
                    data = await response.json();
                    console.log('Response data:', data);
                } catch (jsonError) {
                    const text = await response.text();
                    console.error('Error parsing JSON response:', jsonError, 'Response text:', text);
                    alert(`‚úó Error: Server returned invalid response (${response.status}). Check console for details.`);
                    return;
                }
                
                if (response.ok) {
                    alert(`‚úì Success! Reset plugin "${pluginName}".\n\nDeleted:\n- ${data.items_deleted} data items\n- ${data.logs_deleted} import logs`);
                    // Refresh plugins, stats, and imports
                    console.log('Refreshing plugins, stats, and imports...');
                    loadPlugins();
                    loadStats();
                    loadImports();
                } else {
                    console.error('Reset failed:', data);
                    alert(`‚úó Error: ${data.error || 'Failed to reset plugin'}`);
                }
            } catch (error) {
                console.error('Error resetting plugin:', error);
                alert(`‚úó Error: Failed to reset plugin. ${error.message}\n\nCheck browser console for details.`);
            }
        }
        
        async function clearAllData() {
            // Confirmation
            const confirmed = confirm('‚ö†Ô∏è WARNING: This will delete ALL imported data from the database.\n\nThis includes:\n- All emails\n- All WhatsApp messages\n- All WHOOP data\n\nImport logs will be preserved.\n\nThis action CANNOT be undone.\n\nAre you sure you want to continue?');
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE}/data/clear`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({confirm: true})
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úì Success! Deleted ${data.items_deleted} data items from the database.`);
                    // Refresh stats and imports
                    loadStats();
                    loadImports();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error clearing data:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        async function factoryReset() {
            // Double confirmation for factory reset
            const confirm1 = confirm('üî• FACTORY RESET WARNING üî•\n\nThis will PERMANENTLY DELETE EVERYTHING:\n\n- All imported data (emails, WhatsApp, WHOOP, etc.)\n- All import logs\n- All temporary files\n- All log files\n- All OpenAI vector store files\n- OAuth authentication tokens\n- The entire database (will be recreated empty)\n\nThis action CANNOT be undone!\n\nAre you absolutely sure you want to continue?');
            if (!confirm1) {
                return;
            }
            
            const confirm2 = confirm('‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è\n\nThis is your LAST chance to cancel.\n\nClicking OK will immediately delete EVERYTHING.\n\nAre you 100% certain?');
            if (!confirm2) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE}/factory-reset`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({confirm: true})
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                // Show detailed results
                const results = data.results || {};
                const summary = [
                    `‚úÖ Factory reset completed!`,
                    ``,
                    `Deleted:`,
                    `- ${results.database_items_deleted || 0} database items`,
                    `- ${results.database_logs_deleted || 0} import logs`,
                    `- ${results.temp_files_deleted || 0} temporary files`,
                    `- ${results.log_files_deleted || 0} log files`,
                    `- ${results.vector_store_files_deleted || 0} vector store files`,
                    results.errors && results.errors.length > 0 ? `\n‚ö†Ô∏è Errors: ${results.errors.length}` : ''
                ].join('\n');
                
                alert(summary);
                
                // Refresh all data
                loadStats();
                loadImports();
                loadPlugins();
                
                // Reload the page after a short delay to ensure everything is reset
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Error during factory reset:', error);
                alert(`‚ùå Error during factory reset: ${error.message}`);
            }
        }
        
        // Authentication functions
        let currentUser = null;
        
        async function checkAuth() {
            try {
                const response = await apiFetch(`${API_BASE}/auth/me`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    document.getElementById('user-email').textContent = user.email || 'User';
                    
                    // Show Users tab if admin
                    if (user.is_admin) {
                        document.getElementById('nav-users').style.display = 'block';
                    }
                    
                    return true;
                } else {
                    // Not authenticated, redirect to login
                    window.location.href = '/login';
                    return false;
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                window.location.href = '/login';
                return false;
            }
        }
        
        async function handleLogout() {
            try {
                const response = await apiFetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Error logging out. Please try again.');
                }
            } catch (error) {
                console.error('Error logging out:', error);
                // Still redirect to login even if logout fails
                window.location.href = '/login';
            }
        }
        
        // Chat Instructions functions
        const DEFAULT_CHAT_INSTRUCTIONS = "You are a helpful assistant that can answer questions using both your general knowledge and any relevant context from imported data (Gmail, WhatsApp, WHOOP, etc.). Answer questions naturally and directly. If you find relevant information in the imported data, mention the source when helpful. If the question is about general topics not covered in the imported data, answer using your general knowledge without mentioning that the information wasn't found in the files. Be concise and helpful.";
        
        async function loadChatInstructions() {
            try {
                const response = await apiFetch(`${API_BASE}/settings/assistant-instructions`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const textarea = document.getElementById('assistant-instructions-textarea');
                const statusSpan = document.getElementById('assistant-instructions-status');
                
                if (textarea) {
                    textarea.value = data.instructions || DEFAULT_CHAT_INSTRUCTIONS;
                }
                
                if (statusSpan) {
                    if (data.is_custom) {
                        statusSpan.textContent = '‚úì Using custom instructions';
                        statusSpan.style.color = 'var(--accent-color)';
                    } else {
                        statusSpan.textContent = 'Using default instructions';
                        statusSpan.style.color = 'var(--text-secondary)';
                    }
                }
            } catch (error) {
                console.error('Error loading chat instructions:', error);
                const textarea = document.getElementById('assistant-instructions-textarea');
                if (textarea) {
                    textarea.value = DEFAULT_CHAT_INSTRUCTIONS;
                }
            }
        }
        
        async function saveAssistantInstructions() {
            const textarea = document.getElementById('assistant-instructions-textarea');
            const statusSpan = document.getElementById('assistant-instructions-status');
            
            if (!textarea) {
                return;
            }
            
            const instructions = textarea.value.trim();
            
            if (!instructions) {
                alert('Instructions cannot be empty.');
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE}/settings/assistant-instructions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ instructions: instructions })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (statusSpan) {
                    statusSpan.textContent = '‚úì Saved successfully!';
                    statusSpan.style.color = 'var(--accent-color)';
                    setTimeout(() => {
                        statusSpan.textContent = '‚úì Using custom instructions';
                    }, 2000);
                }
                
                // Note: The assistant will be updated with new instructions on the next chat message
                // when get_or_create_unified_assistant is called
            } catch (error) {
                console.error('Error saving assistant instructions:', error);
                alert(`Error saving instructions: ${error.message}`);
                if (statusSpan) {
                    statusSpan.textContent = '‚úó Error saving';
                    statusSpan.style.color = '#e74c3c';
                }
            }
        }
        
        function resetAssistantInstructions() {
            const textarea = document.getElementById('assistant-instructions-textarea');
            const statusSpan = document.getElementById('assistant-instructions-status');
            
            if (!textarea) {
                return;
            }
            
            const confirmed = confirm('Reset to default instructions? This will clear your custom instructions.');
            if (!confirmed) {
                return;
            }
            
            textarea.value = DEFAULT_ASSISTANT_INSTRUCTIONS;
            
            // Save the default instructions (this will clear the custom ones)
            saveAssistantInstructions().then(() => {
                if (statusSpan) {
                    statusSpan.textContent = 'Reset to default';
                    statusSpan.style.color = 'var(--text-secondary)';
                }
            });
        }
        
        // Load model for chat interface
        async function loadChatModel() {
            try {
                const response = await apiFetch(`${API_BASE}/settings/assistant-model`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const modelNameSpan = document.getElementById('chat-model-name');
                
                if (modelNameSpan) {
                    // Find the display name for the current model
                    const currentModel = data.available_models?.find(m => m.value === data.model);
                    modelNameSpan.textContent = currentModel ? currentModel.label : (data.model || data.default_model || 'gpt-4o-mini');
                }
            } catch (error) {
                console.error('Error loading chat model:', error);
                const modelNameSpan = document.getElementById('chat-model-name');
                if (modelNameSpan) {
                    modelNameSpan.textContent = 'gpt-4o-mini';
                }
            }
        }
        
        // Assistant Model functions
        async function loadAssistantModel() {
            try {
                const response = await apiFetch(`${API_BASE}/settings/assistant-model`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const select = document.getElementById('assistant-model-select');
                const currentSpan = document.getElementById('assistant-model-current');
                const statusSpan = document.getElementById('assistant-model-status');
                
                // Populate dropdown with available models
                if (select && data.available_models) {
                    select.innerHTML = ''; // Clear loading message
                    data.available_models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.value;
                        option.textContent = model.label;
                        select.appendChild(option);
                    });
                    // Set selected value
                    select.value = data.model || data.default_model || 'gpt-4o-mini';
                }
                
                if (currentSpan) {
                    // Find the display name for the current model
                    const currentModel = data.available_models?.find(m => m.value === data.model);
                    currentSpan.textContent = currentModel ? currentModel.label : (data.model || data.default_model || 'gpt-4o-mini');
                }
                
                if (statusSpan) {
                    if (data.is_custom) {
                        statusSpan.textContent = '‚úì Using custom model';
                        statusSpan.style.color = 'var(--accent-color)';
                    } else {
                        statusSpan.textContent = 'Using default model';
                        statusSpan.style.color = 'var(--text-secondary)';
                    }
                }
            } catch (error) {
                console.error('Error loading assistant model:', error);
                const select = document.getElementById('assistant-model-select');
                const currentSpan = document.getElementById('assistant-model-current');
                if (select) {
                    select.innerHTML = '<option value="">Error loading models</option>';
                }
                if (currentSpan) {
                    currentSpan.textContent = 'Error loading model';
                }
            }
        }
        
        async function saveAssistantModel() {
            const select = document.getElementById('assistant-model-select');
            const statusSpan = document.getElementById('assistant-model-status');
            const currentSpan = document.getElementById('assistant-model-current');
            
            if (!select) {
                return;
            }
            
            const model = select.value;
            
            if (!model) {
                alert('Please select a model.');
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE}/settings/assistant-model`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ model: model })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (statusSpan) {
                    statusSpan.textContent = '‚úì Saved successfully!';
                    statusSpan.style.color = 'var(--accent-color)';
                    setTimeout(() => {
                        statusSpan.textContent = '‚úì Using custom model';
                    }, 2000);
                }
                
                // Reload the model list to get updated display names
                await loadAssistantModel();
                
                // Update chat interface model indicator
                await loadChatModel();
                
                // Note: The assistant will be updated with new model on the next chat message
                // when get_or_create_unified_assistant is called
            } catch (error) {
                console.error('Error saving assistant model:', error);
                alert(`Error saving model: ${error.message}`);
                if (statusSpan) {
                    statusSpan.textContent = '‚úó Error saving';
                    statusSpan.style.color = '#e74c3c';
                }
            }
        }
        
        // Initialize theme on page load
        initTheme();
        
        // Check authentication and load user info
        checkAuth().then(isAuthenticated => {
            if (isAuthenticated) {
                // Load initial data only if authenticated
                loadImports();
            }
        });
        
        // Load users management page
        async function loadUsers() {
            try {
                const response = await apiFetch(`${API_BASE}/users/pending`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const pendingUsers = await response.json();
                
                let html = '<div class="card">';
                html += '<h3>Pending User Approvals</h3>';
                
                if (pendingUsers.length === 0) {
                    html += '<p style="color: var(--text-secondary);">No pending user approvals.</p>';
                } else {
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
                    html += '<thead><tr style="border-bottom: 2px solid var(--border-color);">';
                    html += '<th style="text-align: left; padding: 10px;">Email</th>';
                    html += '<th style="text-align: left; padding: 10px;">Registered</th>';
                    html += '<th style="text-align: center; padding: 10px;">Actions</th>';
                    html += '</tr></thead><tbody>';
                    
                    for (const user of pendingUsers) {
                        const date = new Date(user.created_at);
                        html += '<tr style="border-bottom: 1px solid var(--border-color);">';
                        html += `<td style="padding: 10px;">${user.email}</td>`;
                        html += `<td style="padding: 10px; color: var(--text-secondary);">${date.toLocaleString()}</td>`;
                        html += '<td style="padding: 10px; text-align: center;">';
                        html += `<button class="btn btn-success" onclick="approveUser(${user.id}, '${user.email}')" style="margin-right: 5px;">Approve</button>`;
                        html += `<button class="btn btn-danger" onclick="declineUser(${user.id}, '${user.email}')">Decline</button>`;
                        html += '</td></tr>';
                    }
                    
                    html += '</tbody></table>';
                }
                
                html += '</div>';
                
                // Add all users section
                html += '<div class="card" style="margin-top: 20px;">';
                html += '<h3>All Users</h3>';
                html += '<div id="all-users-list">Loading...</div>';
                html += '</div>';
                
                document.getElementById('users-content').innerHTML = html;
                
                // Load all users
                loadAllUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-content').innerHTML = `<p style="color: red;">Error loading users: ${error.message}</p>`;
            }
        }
        
        async function loadAllUsers() {
            try {
                const response = await apiFetch(`${API_BASE}/users`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const users = await response.json();
                
                let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
                html += '<thead><tr style="border-bottom: 2px solid var(--border-color);">';
                html += '<th style="text-align: left; padding: 10px;">Email</th>';
                html += '<th style="text-align: left; padding: 10px;">Role</th>';
                html += '<th style="text-align: left; padding: 10px;">Status</th>';
                html += '<th style="text-align: left; padding: 10px;">Registered</th>';
                html += '<th style="text-align: center; padding: 10px;">Actions</th>';
                html += '</tr></thead><tbody>';
                
                for (const user of users) {
                    const date = new Date(user.created_at);
                    const status = user.active ? '<span style="color: #27ae60;">‚úì Active</span>' : '<span style="color: #e74c3c;">‚è≥ Pending</span>';
                    const roleBadge = user.role === 'admin' ? '<span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Admin</span>' : 'Regular';
                    
                    html += '<tr style="border-bottom: 1px solid var(--border-color);">';
                    html += `<td style="padding: 10px;">${user.email}</td>`;
                    html += `<td style="padding: 10px;">${roleBadge}</td>`;
                    html += `<td style="padding: 10px;">${status}</td>`;
                    html += `<td style="padding: 10px; color: var(--text-secondary);">${date.toLocaleString()}</td>`;
                    html += '<td style="padding: 10px; text-align: center;">';
                    
                    if (!user.active) {
                        html += `<button class="btn btn-success" onclick="approveUser(${user.id}, '${user.email}')" style="margin-right: 5px; font-size: 12px; padding: 5px 10px;">Approve</button>`;
                        html += `<button class="btn btn-danger" onclick="declineUser(${user.id}, '${user.email}')" style="font-size: 12px; padding: 5px 10px;">Decline</button>`;
                    } else if (user.role !== 'admin' && user.id !== currentUser.id) {
                        html += `<button class="btn btn-secondary" onclick="deactivateUser(${user.id}, '${user.email}')" style="font-size: 12px; padding: 5px 10px;">Deactivate</button>`;
                    }
                    
                    html += '</td></tr>';
                }
                
                html += '</tbody></table>';
                document.getElementById('all-users-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading all users:', error);
                document.getElementById('all-users-list').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        async function approveUser(userId, email) {
            if (!confirm(`Approve user ${email}?`)) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE}/users/${userId}/approve`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úì ${data.message}`);
                    loadUsers();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error approving user:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        async function declineUser(userId, email) {
            if (!confirm(`Decline and delete user ${email}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE}/users/${userId}/decline`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úì ${data.message}`);
                    loadUsers();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error declining user:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        async function deactivateUser(userId, email) {
            if (!confirm(`Deactivate user ${email}? They will not be able to log in until reactivated.`)) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE}/users/${userId}/deactivate`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úì ${data.message}`);
                    loadUsers();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deactivating user:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Initialize chat on page load
        window.addEventListener('DOMContentLoaded', function() {
            initChat();
        });
    </script>
</body>
</html>

